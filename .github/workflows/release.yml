# Build native binaries and publish a GitHub Release with Homebrew-ready tarballs.
#
# Triggered by pushing a version tag: git tag v0.1.0 && git push --tags
#
# Matrix builds for:
#   - macOS arm64 (Apple Silicon)
#   - Linux x86_64 (built on Ubuntu 22.04 for broad glibc 2.35+ compatibility)
#   - Linux arm64  (built on Ubuntu 22.04 for broad glibc 2.35+ compatibility)
#
# After all builds complete, a release job collects the artifacts, creates a
# GitHub Release, and auto-updates the Homebrew Formula with SHA256s.

name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

env:
  JAVA_VERSION: "25"
  GRAALVM_DISTRIBUTION: "graalvm-community"

jobs:
  # ---------------------------------------------------------------------------
  # Build native binaries on each platform
  # ---------------------------------------------------------------------------
  build:
    name: Build (${{ matrix.os-label }}-${{ matrix.arch-label }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15            # Apple Silicon (M1+)
            os-label: macos
            arch-label: arm64
          - runner: ubuntu-22.04        # Linux x86_64 (glibc 2.35 for broad compat)
            os-label: linux
            arch-label: x86_64
          - runner: ubuntu-22.04-arm    # Linux arm64 (glibc 2.35 for broad compat)
            os-label: linux
            arch-label: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.GRAALVM_DISTRIBUTION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Build native image
        run: ./gradlew nativeCompile

      - name: Verify binary
        run: |
          ls -lh build/native/nativeCompile/noetic
          file build/native/nativeCompile/noetic
          ./build/native/nativeCompile/noetic --version

      # Optional: sign macOS binary (requires APPLE_CERTIFICATE secret)
      - name: Sign binary (macOS)
        if: matrix.os-label == 'macos' && env.APPLE_CERTIFICATE != ''
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
        run: |
          # Import certificate
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain \
            -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "" build.keychain

          # Sign
          codesign --force --options runtime \
            --sign "$APPLE_IDENTITY" \
            build/native/nativeCompile/noetic

          # Verify
          codesign --verify --verbose build/native/nativeCompile/noetic
          rm -f certificate.p12

      - name: Package tarball
        id: package
        env:
          VERSION: ${{ steps.version.outputs.version }}
          OS_LABEL: ${{ matrix.os-label }}
          ARCH_LABEL: ${{ matrix.arch-label }}
        run: |
          TARBALL="noetic-${VERSION}-${OS_LABEL}-${ARCH_LABEL}.tar.gz"

          mkdir -p dist/staging

          # Single native binary
          cp build/native/nativeCompile/noetic dist/staging/noetic
          chmod +x dist/staging/noetic

          # Helper scripts
          for script in noetic-start noetic-stop mcp-server.sh; do
            if [ -f "bin/$script" ]; then
              cp "bin/$script" "dist/staging/$script"
              chmod +x "dist/staging/$script"
            fi
          done

          tar -czf "dist/${TARBALL}" -C dist/staging .
          rm -rf dist/staging

          SHA256=$(shasum -a 256 "dist/${TARBALL}" | awk '{print $1}')
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"

          echo "Tarball: ${TARBALL}"
          echo "SHA256:  ${SHA256}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: noetic-${{ matrix.os-label }}-${{ matrix.arch-label }}
          path: dist/${{ steps.package.outputs.tarball }}

      - name: Save SHA256
        run: |
          mkdir -p dist
          echo "${{ steps.package.outputs.sha256 }}  ${{ steps.package.outputs.tarball }}" > dist/sha256-${{ matrix.os-label }}-${{ matrix.arch-label }}.txt

      - name: Upload SHA256
        uses: actions/upload-artifact@v4
        with:
          name: sha256-${{ matrix.os-label }}-${{ matrix.arch-label }}
          path: dist/sha256-${{ matrix.os-label }}-${{ matrix.arch-label }}.txt

  # ---------------------------------------------------------------------------
  # Create GitHub Release with all platform tarballs
  # ---------------------------------------------------------------------------
  release:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract version from tag
        id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release assets
        run: |
          mkdir -p release
          find artifacts -name '*.tar.gz' -exec cp {} release/ \;

          # Combine checksums
          echo "# SHA256 Checksums" > release/checksums.txt
          echo "" >> release/checksums.txt
          find artifacts -name 'sha256-*.txt' -exec cat {} \; >> release/checksums.txt
          cat release/checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Noetic v${{ steps.version.outputs.version }}
          body: |
            ## Noetic v${{ steps.version.outputs.version }}

            Web search, crawl, and knowledge cache for AI coding assistants.

            ### Install via Homebrew

            ```bash
            brew tap dnamaz/tap
            brew install noetic
            ```

            ### Manual install

            Download the tarball for your platform below, extract, and add to your PATH:

            ```bash
            tar -xzf noetic-${{ steps.version.outputs.version }}-macos-arm64.tar.gz -C ~/.local/bin/
            ```

            ### What's included

            - `noetic` - Single native binary (MCP server, REST API, CLI)
            - `noetic-start` / `noetic-stop` - Service management scripts
            - `mcp-server.sh` - MCP STDIO launcher for IDE integration

            Linux binaries are built on Ubuntu 22.04 (glibc 2.35) for broad compatibility
            with Ubuntu 22.04+, Debian 12+, Fedora 36+, Amazon Linux 2023+.

            ### Checksums

            See `checksums.txt` attached to this release.
          files: |
            release/*.tar.gz
            release/checksums.txt
          draft: false
          prerelease: false

      - name: Extract SHA256 values
        id: sha256
        run: |
          for file in artifacts/sha256-*/sha256-*.txt; do
            hash=$(awk '{print $1}' "$file")
            name=$(basename "$file" .txt)
            # sha256-macos-arm64 -> MACOS_ARM64
            key=$(echo "${name#sha256-}" | tr '[:lower:]-' '[:upper:]_')
            echo "${key}=${hash}" >> "$GITHUB_OUTPUT"
            echo "  ${key}=${hash}"
          done

      - name: Update Homebrew Formula
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version.outputs.version }}
          SHA_MACOS_ARM64: ${{ steps.sha256.outputs.MACOS_ARM64 }}
          SHA_LINUX_X86_64: ${{ steps.sha256.outputs.LINUX_X86_64 }}
          SHA_LINUX_ARM64: ${{ steps.sha256.outputs.LINUX_ARM64 }}
        run: |
          # Generate updated Formula
          cat > /tmp/noetic.rb <<FORMULA
          class Noetic < Formula
            desc "Web search, crawl, and knowledge cache for AI coding assistants"
            homepage "https://github.com/dnamaz/noetic"
            version "${VERSION}"
            license "MIT"

            on_macos do
              url "https://github.com/dnamaz/noetic/releases/download/v#{version}/noetic-#{version}-macos-arm64.tar.gz"
              sha256 "${SHA_MACOS_ARM64}"
            end

            on_linux do
              if Hardware::CPU.arm?
                url "https://github.com/dnamaz/noetic/releases/download/v#{version}/noetic-#{version}-linux-arm64.tar.gz"
                sha256 "${SHA_LINUX_ARM64}"
              else
                url "https://github.com/dnamaz/noetic/releases/download/v#{version}/noetic-#{version}-linux-x86_64.tar.gz"
                sha256 "${SHA_LINUX_X86_64}"
              end
            end

            def install
              bin.install "noetic"
              bin.install "noetic-start" if File.exist?("noetic-start")
              bin.install "noetic-stop"  if File.exist?("noetic-stop")
              bin.install "mcp-server.sh" if File.exist?("mcp-server.sh")
            end

            service do
              run [opt_bin/"noetic",
                   "--server.port=8090",
                   "--websearch.adapter.default-mode=rest"]
              keep_alive true
              log_path var/"log/noetic.log"
              error_log_path var/"log/noetic.log"
              working_dir var/"noetic"
            end

            def post_install
              (var/"noetic").mkpath
              (var/"log").mkpath
            end

            def caveats
              <<~EOS
                CLI (works immediately, no server needed):
                  noetic --websearch.adapter.default-mode=cli search "your query"
                  noetic --websearch.adapter.default-mode=cli crawl "https://example.com"

                Start the REST API server as a background service:
                  brew services start noetic

                Or run the MCP server (foreground, for IDE integration):
                  noetic

                Install AI assistant instructions:
                  noetic install-skill --target=cursor
                  noetic install-skill --list

                Server logs:  #{var}/log/noetic.log
                Model cache:  ~/.websearch/models/
                Vector cache: ~/.websearch/index/
              EOS
            end

            test do
              assert_match "noetic", shell_output("#{bin}/noetic --version")
              assert_match version.to_s, shell_output("#{bin}/noetic --version")
            end
          end
          FORMULA

          # Remove leading whitespace from heredoc
          sed -i 's/^          //' /tmp/noetic.rb

          # Get current SHA of the file in the tap repo
          TAP_SHA=$(gh api repos/dnamaz/homebrew-tap/contents/Formula/noetic.rb --jq '.sha')

          # Push updated Formula
          gh api repos/dnamaz/homebrew-tap/contents/Formula/noetic.rb \
            -X PUT \
            -f message="Update Formula for v${VERSION} with CI-built SHA256s" \
            -f content="$(base64 -w0 /tmp/noetic.rb)" \
            -f sha="$TAP_SHA" \
            --silent

          echo "Homebrew Formula updated for v${VERSION}"
