# Build native binaries and publish a GitHub Release with Homebrew-ready tarballs.
#
# Triggered manually via workflow_dispatch. After release, update the Homebrew
# Formula in dnamaz/homebrew-tap with the SHA256s from the checksums.txt.
#
# Matrix builds for:
#   - macOS arm64 (Apple Silicon)
#   - Linux x86_64 (built on Ubuntu 22.04 for broad glibc 2.35+ compatibility)
#   - Linux arm64  (built on Ubuntu 22.04 for broad glibc 2.35+ compatibility)

name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.1.0)"
        required: true
        default: "0.1.0"

permissions:
  contents: write

env:
  JAVA_VERSION: "25"
  GRAALVM_DISTRIBUTION: "graalvm-community"

jobs:
  # ---------------------------------------------------------------------------
  # Build native binaries on each platform
  # ---------------------------------------------------------------------------
  build:
    name: Build (${{ matrix.os-label }}-${{ matrix.arch-label }})
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - runner: macos-15            # Apple Silicon (M1+)
            os-label: macos
            arch-label: arm64
          - runner: ubuntu-22.04        # Linux x86_64 (glibc 2.35 for broad compat)
            os-label: linux
            arch-label: x86_64
          - runner: ubuntu-22.04-arm    # Linux arm64 (glibc 2.35 for broad compat)
            os-label: linux
            arch-label: arm64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.GRAALVM_DISTRIBUTION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build native image
        run: ./gradlew nativeCompile

      - name: Verify binary
        run: |
          ls -lh build/native/nativeCompile/noetic
          file build/native/nativeCompile/noetic
          ./build/native/nativeCompile/noetic --version

      # Optional: sign macOS binary (requires APPLE_CERTIFICATE secret)
      - name: Sign binary (macOS)
        if: matrix.os-label == 'macos' && env.APPLE_CERTIFICATE != ''
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain \
            -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "" build.keychain
          codesign --force --options runtime \
            --sign "$APPLE_IDENTITY" \
            build/native/nativeCompile/noetic
          codesign --verify --verbose build/native/nativeCompile/noetic
          rm -f certificate.p12

      - name: Package tarball
        id: package
        env:
          VERSION: ${{ inputs.version }}
          OS_LABEL: ${{ matrix.os-label }}
          ARCH_LABEL: ${{ matrix.arch-label }}
        run: |
          TARBALL="noetic-${VERSION}-${OS_LABEL}-${ARCH_LABEL}.tar.gz"

          mkdir -p dist/staging
          cp build/native/nativeCompile/noetic dist/staging/noetic
          chmod +x dist/staging/noetic

          for script in noetic-start noetic-stop mcp-server.sh; do
            if [ -f "bin/$script" ]; then
              cp "bin/$script" "dist/staging/$script"
              chmod +x "dist/staging/$script"
            fi
          done

          tar -czf "dist/${TARBALL}" -C dist/staging .
          rm -rf dist/staging

          SHA256=$(shasum -a 256 "dist/${TARBALL}" | awk '{print $1}')
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"

          echo "Tarball: ${TARBALL}"
          echo "SHA256:  ${SHA256}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: noetic-${{ matrix.os-label }}-${{ matrix.arch-label }}
          path: dist/${{ steps.package.outputs.tarball }}

      - name: Save SHA256
        run: |
          mkdir -p dist
          echo "${{ steps.package.outputs.sha256 }}  ${{ steps.package.outputs.tarball }}" > dist/sha256-${{ matrix.os-label }}-${{ matrix.arch-label }}.txt

      - name: Upload SHA256
        uses: actions/upload-artifact@v4
        with:
          name: sha256-${{ matrix.os-label }}-${{ matrix.arch-label }}
          path: dist/sha256-${{ matrix.os-label }}-${{ matrix.arch-label }}.txt

  # ---------------------------------------------------------------------------
  # Create GitHub Release with all platform tarballs
  # ---------------------------------------------------------------------------
  release:
    name: Publish Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release assets
        run: |
          mkdir -p release
          find artifacts -name '*.tar.gz' -exec cp {} release/ \;

          echo "# SHA256 Checksums" > release/checksums.txt
          echo "" >> release/checksums.txt
          find artifacts -name 'sha256-*.txt' -exec cat {} \; >> release/checksums.txt
          cat release/checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ inputs.version }}
          name: Noetic v${{ inputs.version }}
          body: |
            ## Noetic v${{ inputs.version }}

            Web search, crawl, and knowledge cache for AI coding assistants.

            ### Install via Homebrew

            ```bash
            brew tap dnamaz/tap
            brew install noetic
            ```

            ### Manual install

            Download the tarball for your platform below, extract, and add to your PATH:

            ```bash
            tar -xzf noetic-${{ inputs.version }}-macos-arm64.tar.gz -C ~/.local/bin/
            ```

            ### What's included

            - `noetic` - Single native binary (MCP server, REST API, CLI)
            - `noetic-start` / `noetic-stop` - Service management scripts
            - `mcp-server.sh` - MCP STDIO launcher for IDE integration

            Linux binaries are built on Ubuntu 22.04 (glibc 2.35) for broad compatibility
            with Ubuntu 22.04+, Debian 12+, Fedora 36+, Amazon Linux 2023+.

            ### Update Homebrew Formula

            After this release, update `dnamaz/homebrew-tap` Formula/noetic.rb
            with the SHA256 values from `checksums.txt`.

            ### Checksums

            See `checksums.txt` attached to this release.
          files: |
            release/*.tar.gz
            release/checksums.txt
          draft: false
          prerelease: false
