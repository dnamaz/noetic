# Build native binaries and publish a GitHub Release.
#
# Triggers:
#   - Tag push:          git tag v0.2.0 && git push --tags
#   - Manual dispatch:   Actions UI with version + platform selection
#
# Matrix builds for:
#   - macOS arm64 (Apple Silicon)
#   - Linux x86_64 (Ubuntu 22.04, glibc 2.35+)
#   - Linux arm64  (Ubuntu 22.04, glibc 2.35+)
#
# After release, manually update dnamaz/homebrew-tap Formula with SHA256s.

name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g. 0.2.0). Ignored if triggered by tag."
        required: false
        default: "0.1.0"
      build_macos_arm64:
        description: "Build macOS arm64"
        type: boolean
        default: true
      build_linux_x86_64:
        description: "Build Linux x86_64"
        type: boolean
        default: true
      build_linux_arm64:
        description: "Build Linux arm64"
        type: boolean
        default: true

permissions:
  contents: write

env:
  JAVA_VERSION: "25"
  GRAALVM_DISTRIBUTION: "graalvm-community"

jobs:
  # ---------------------------------------------------------------------------
  # Resolve version from tag or manual input
  # ---------------------------------------------------------------------------
  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      matrix: ${{ steps.matrix.outputs.matrix }}
    steps:
      - name: Resolve version
        id: version
        run: |
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"
          else
            echo "version=${{ inputs.version }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build matrix
        id: matrix
        run: |
          INCLUDES="["

          # Tag push: build all platforms. Manual: respect checkboxes.
          if [[ "${{ github.ref_type }}" == "tag" ]] || [[ "${{ inputs.build_macos_arm64 }}" == "true" ]]; then
            INCLUDES="${INCLUDES}{\"runner\":\"macos-15\",\"os-label\":\"macos\",\"arch-label\":\"arm64\"},"
          fi
          if [[ "${{ github.ref_type }}" == "tag" ]] || [[ "${{ inputs.build_linux_x86_64 }}" == "true" ]]; then
            INCLUDES="${INCLUDES}{\"runner\":\"ubuntu-22.04\",\"os-label\":\"linux\",\"arch-label\":\"x86_64\"},"
          fi
          if [[ "${{ github.ref_type }}" == "tag" ]] || [[ "${{ inputs.build_linux_arm64 }}" == "true" ]]; then
            INCLUDES="${INCLUDES}{\"runner\":\"ubuntu-22.04-arm\",\"os-label\":\"linux\",\"arch-label\":\"arm64\"},"
          fi

          # Remove trailing comma, close bracket
          INCLUDES="${INCLUDES%,}]"
          echo "matrix={\"include\":${INCLUDES}}" >> "$GITHUB_OUTPUT"
          echo "Matrix: ${INCLUDES}"

  # ---------------------------------------------------------------------------
  # Build native binaries
  # ---------------------------------------------------------------------------
  build:
    name: Build (${{ matrix.os-label }}-${{ matrix.arch-label }})
    needs: prepare
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up GraalVM
        uses: graalvm/setup-graalvm@v1
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: ${{ env.GRAALVM_DISTRIBUTION }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build native image
        run: ./gradlew nativeCompile

      - name: Verify binary
        run: |
          ls -lh build/native/nativeCompile/noetic
          file build/native/nativeCompile/noetic
          ./build/native/nativeCompile/noetic --version

      - name: Sign binary (macOS)
        if: matrix.os-label == 'macos' && env.APPLE_CERTIFICATE != ''
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
        run: |
          echo "$APPLE_CERTIFICATE" | base64 --decode > certificate.p12
          security create-keychain -p "" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "" build.keychain
          security import certificate.p12 -k build.keychain \
            -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "" build.keychain
          codesign --force --options runtime \
            --sign "$APPLE_IDENTITY" \
            build/native/nativeCompile/noetic
          codesign --verify --verbose build/native/nativeCompile/noetic
          rm -f certificate.p12

      - name: Package tarball
        id: package
        env:
          VERSION: ${{ needs.prepare.outputs.version }}
          OS_LABEL: ${{ matrix.os-label }}
          ARCH_LABEL: ${{ matrix.arch-label }}
        run: |
          TARBALL="noetic-${VERSION}-${OS_LABEL}-${ARCH_LABEL}.tar.gz"

          mkdir -p dist/staging
          cp build/native/nativeCompile/noetic dist/staging/noetic
          chmod +x dist/staging/noetic

          for script in noetic-start noetic-stop mcp-server.sh; do
            if [ -f "bin/$script" ]; then
              cp "bin/$script" "dist/staging/$script"
              chmod +x "dist/staging/$script"
            fi
          done

          tar -czf "dist/${TARBALL}" -C dist/staging .
          rm -rf dist/staging

          SHA256=$(shasum -a 256 "dist/${TARBALL}" | awk '{print $1}')
          echo "tarball=${TARBALL}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"
          echo "Tarball: ${TARBALL}"
          echo "SHA256:  ${SHA256}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: noetic-${{ matrix.os-label }}-${{ matrix.arch-label }}
          path: dist/${{ steps.package.outputs.tarball }}

      - name: Save SHA256
        run: |
          mkdir -p dist
          echo "${{ steps.package.outputs.sha256 }}  ${{ steps.package.outputs.tarball }}" > dist/sha256-${{ matrix.os-label }}-${{ matrix.arch-label }}.txt

      - name: Upload SHA256
        uses: actions/upload-artifact@v4
        with:
          name: sha256-${{ matrix.os-label }}-${{ matrix.arch-label }}
          path: dist/sha256-${{ matrix.os-label }}-${{ matrix.arch-label }}.txt

  # ---------------------------------------------------------------------------
  # Create GitHub Release
  # ---------------------------------------------------------------------------
  release:
    name: Publish Release
    needs: [prepare, build]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Collect release assets
        run: |
          mkdir -p release
          find artifacts -name '*.tar.gz' -exec cp {} release/ \;

          echo "# SHA256 Checksums" > release/checksums.txt
          echo "" >> release/checksums.txt
          find artifacts -name 'sha256-*.txt' -exec cat {} \; >> release/checksums.txt
          echo ""
          echo "=== Checksums ==="
          cat release/checksums.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.prepare.outputs.version }}
          name: Noetic v${{ needs.prepare.outputs.version }}
          body: |
            ## Noetic v${{ needs.prepare.outputs.version }}

            Web search, crawl, and knowledge cache for AI coding assistants.

            ### Install via Homebrew

            ```bash
            brew tap dnamaz/tap
            brew install noetic
            ```

            ### Manual install

            ```bash
            tar -xzf noetic-${{ needs.prepare.outputs.version }}-macos-arm64.tar.gz -C ~/.local/bin/
            ```

            ### What's included

            - `noetic` - Single native binary (MCP server, REST API, CLI)
            - `noetic-start` / `noetic-stop` - Service management scripts
            - `mcp-server.sh` - MCP STDIO launcher for IDE integration

            Linux binaries built on Ubuntu 22.04 (glibc 2.35+).

            ### Checksums

            See `checksums.txt` attached to this release.
          files: |
            release/*.tar.gz
            release/checksums.txt
          draft: false
          prerelease: false
